/*
    This project is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Deviation is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Deviation.  If not, see <http://www.gnu.org/licenses/>.

    This file is partially based upon the CooCox ILI9341S driver
    http://www.coocox.org/driver_repo/305488dd-734b-4cce-a8a4-39dcfef8cc66/html/group___i_l_i9341_s.html
*/

#include <libopencm3/stm32/gpio.h>
#include "common.h"
#include "lcd.h"

extern u8 window;
void TW8816_Init()
{
    static const u8 reg_init[] = {
#if 0
        0xFF,     0,
           2,  0x44,
           4,     0,
           6,     3,
           7,  0x12,
           8,  0x12,
           9,  0x20,
         0xA,   0xC,
         0xB,  0xD0,
         0xC,  0xCC,
         0xD,  0x15,
        0x10,     0,
        0x11,  0x5C,
        0x12,  0x11,
        0x13,  0x80,
        0x14,  0x80,
        0x15,     0,
        0x17,  0x30,
        0x18,  0x44,
        0x1C,     7,
        0x1D,  0x7F,
        0x1E,     8,
        0x1F,     0,
        0x20,  0x50,
        0x21,  0x42,
        0x22,  0xF0,
        0x23,  0xD8,
        0x24,  0xBC,
        0x25,  0xB8,
        0x26,  0x44,
        0x27,  0x2A,
        0x28,     0,
        0x29,     0,
        0x2A,  0x78,
        0x2B,  0x44,
        0x2C,  0x30,
        0x2D,  0x14,
        0x2E,  0xA5,
        0x2F,  0xE6,
        0x33,     5,
        0x34,  0x1A,
        0x35,     0,
        0x38,  0x80,
        0x40,     0,
        0x41,  0x20,
        0x42,     0,
        0x43,  0x20,
        0x44,   0xC,
        0x45,  0x84,
        0x46,  0x20,
        0x49,  0x81,
        0x47,  0x18,
        0x48,     0,
        0x4D,  0x30,
        0x4A,     8,
        0x4B,     9,
        0x4C,  0x20,
        0x4E,     0,
        0x4F,     0,
        0x50,     0,
        0x60,  0xE3,
        0x61,  0x80,
        0x62,  0x94,
        0x63,     0,
        0x64,     0,
        0x65,  0x80,
        0x66,     0,
        0x67,     0,
        0x68,     0,
        0x69,  0x80,
        0x6A,     0,
        0x6B,     0,
        0x6C,     0,
        0x6D,     0,
        0x6E,     0,
        0x70,  0x60,
        0x71,  0x80,
        0x72,  0x80,
        0x73,  0x80,
        0x74,  0x80,
        0x75,  0x80,
        0x76,  0x80,
        0x77,  0x3F,
        0x78,   0xA,
        0x7C,  0x1C,
        0x7D,     8,
        0x7E,  0xF6,
        0x7F,     8,
        0x80,  0x10,
        0x81,   0xD,
        0x82,     3,
        0x83,     0,
        0x84,  0x67,
        0x85,  0x94,
        0x86,  0x18,
        0x87,  0xE8,
        0x88,  0xCA,
        0x89,     2,
        0xB0,  0x48,
        0xB1,     0,
        0xB2,  0x20,
        0xB3,  0x32,
        0xB4,  0x10,
        0xB5,  0x20,
        0xB6,  0x34,
        0xB7,  0x10,
        0xB8,  0x14,
        0xB9,  0x16,
        0xBA,  0xE2,
        0xBB,  0x12,
        0xBC,     0,
        0xBD,   0xC,
        0xBE,  0x42,
        0xBF,     0,
        0xC0,     0,
        0xC1,     0,
        0xC2,     0,
        0xC3,     0,
        0xC4,  0x40,
        0xC6,     0,
        0xC7,     0,
        0xC8,     0,
        0xD0,  0xC1,
        0xD1,     8,
        0xD2,  0xFF,
        0xD3,     0,
        0xD4,     0,
        0xD5,  0x3F,
        0xD6,     0,
        0xD7,     0,
        0xD8,     0,
        0xDA,  0x3D,
        0xDB,  0xC3,
        0xDC,  0xFC,
        0xDD,     0,
        0xDE,     0,
        0xDF,     0,
        0xE0,     0,
        0xF0,     0,
        0xF1,     0,
        0xF2,     0,
        0xF4,     0,
        0xF6,     0,
        0xF7,     0,
        0xF8,     0,
        0xF9,     0,
        0xFA,  0x92,
        0xFB,     0,
        0xFC,  0x40,
        0xFD,  0x30,
        0xFE,     0,
        0xFF,     1,
           0,     0,
        0x30,  0xF2,
        0x31,  0xAD,
        0x32,     4,
        0x33,  0x80,
        0x34,  0x84,
        0x35,     0,
        0x36,  0x20,
        0x40,     0,
        0x41,     0,
        0x75,     0,
        0x76,     0,
        0x77,  0x5A,
        0x78,     0,
        0x79,  0x7F,
        0x7A,     1,
        0x7B,     0,
        0x80,  0x20,
        0x81,     0,
        0x82,     5,
        0x83,  0x1F,
        0x84,     0,
        0x85,     0,
        0x8A,     2,
        0x8B,  0x4D,
        0x8C,     0,
        0x8D,     6,
        0x8E,     1,
        0x8F,  0xE2,
        0x90,     2,
        0x91,  0xD0,
        0x92,     2,
        0x93,  0xD0,
        0x94,     0,
        0x95,     6,
        0x9A,     0,
        0x9B,  0xC8,
        0x9C,     0,
        0x9D,     1,
        0xA0,     0,
        0xA1,     0,
        0xA2,     2,
        0xA3,  0x30,
        0xA4,     0,
        0xA5,     6,
        0xA6,     0,
        0xA7,     1,
        0xAC,     0,
        0xAD,   0xA,
        0xAE,     0,
        0xAF,  0x36,
        0xB0,     2,
        0xB1,     3,
        0xB2,  0x88,
        0xB3,     0,
        0xB4,     0,
        0xC0,     5,
        0xC2,     0,
        0xC3,     3,
        0xC4,  0x5A,
        0xC5,     0,
        0xC6,  0x20,
        0xC7,     4,
        0xC8,     0,
        0xC9,     6,
        0xCA,     6,
        0xCB,  0x70,
        0xCC,     0,
        0xCD,     0,
        0xD0,     0,
        0xD1,  0xF0,
        0xD2,  0xF0,
        0xD3,  0xF0,
        0xD4,     0,
        0xD5,     0,
        0xD6,  0x10,
        0xD7,  0x70,
        0xD8,     0,
        0xD9,     4,
        0xDA,  0x80,
        0xDB,  0x80,
        0xDC,  0x20,
        0xE0,     0,
        0xF0,     0,
        0xF1,     0,
        0xF3,     4,
#else
 0xFF,     0,
    2,  0x44,
    4,     0,
    6,     3,
    7,     2,
    8,  0x12,
    9,  0xF0,
  0xA,   0xC,
  0xB,  0xD0,
  0xC,  0xCC,
  0xD,  0x15,
 0x10,     0,
 0x11,  0x5C,
 0x12,  0x11,
 0x13,  0x80,
 0x14,  0x80,
 0x15,     0,
 0x17,  0x30,
 0x18,  0x44,
 0x1C,     7,
 0x1D,  0x7F,
 0x1E,     8,
 0x1F,     0,
 0x20,  0x50,
 0x21,  0x42,
 0x22,  0xF0,
 0x23,  0xD8,
 0x24,  0xBC,
 0x25,  0xB8,
 0x26,  0x44,
 0x27,  0x2A,
 0x28,     0,
 0x29,     0,
 0x2A,  0x78,
 0x2B,  0x44,
 0x2C,  0x30,
 0x2D,  0x14,
 0x2E,  0xA5,
 0x2F,  0xE6,
 0x33,     5,
 0x34,  0x1A,
 0x35,     0,
 0x38,  0x80,
 0x40,     0,
 0x41,  0x20,
 0x42,     0,
 0x43,  0x20,
 0x44,   0xC,
 0x45,  0x84,
 0x46,  0x20,
 0x49,  0x81,
 0x47,  0x18,
 0x48,     0,
 0x4D,  0x30,
 0x4A,     8,
 0x4B,     9,
 0x4C,  0x20,
 0x4E,     0,
 0x4F,     0,
 0x50,     0,
 0x60,  0xE3,
 0x61,  0x80,
 0x62,  0x76,
 0x63,     0,
 0x64,     0,
 0x65,  0x80,
 0x66,     0,
 0x67,     0,
 0x68,     0,
 0x69,  0x80,
 0x6A,     0,
 0x6B,     0,
 0x6C,     0,
 0x6D,     0,
 0x6E,     0,
 0x70,  0x20,
 0x71,  0x80,
 0x72,  0x80,
 0x73,  0x80,
 0x74,  0x80,
 0x75,  0x80,
 0x76,  0x80,
 0x77,  0x3F,
 0x78,   0xA,
 0x7C,  0x1C,
 0x7D,     8,
 0x7E,  0xF6,
 0x7F,     8,
 0x80,  0x10,
 0x81,   0xD,
 0x82,     3,
 0x83,     0,
 0x84,  0x67,
 0x85,  0x94,
 0x86,  0x18,
 0x87,  0xE8,
 0x88,  0xCA,
 0x89,     2,
 0x9E,     0,
 0x9F,     1,
 0xA0,     0,
 0xA1,     0,
 0xA2,     0,
 0xA3,  0x14,
 0xA4,     2,
 0xA5,  0x11,
 0xA6,   0xE,
 0xA7,  0x36,
 0xA8,     0,
// 0xA9,  0xA0,
 0xA9,  0x50,
 0xAA,     0,
 0xAB,  0x12,
 0xAC,   0xF,
 0xAD,     0,
 0xAE,     0,
 0xB0,  0x48,
 0xB1,     0,
 0xB2,  0x20,
 0xB3,  0xD2,
 0xB4,  0x2E,
 0xB5,  0x20,
 0xB6,  0x34,
 0xB7,  0x10,
 0xB8,  0x16,
 0xB9,  0x17,
 0xBA,  0xE0,
 0xBB,  0x12,
 0xBC,     0,
 0xBD,   0xC,
 0xBE,  0xC0,
 0xBF,     0,
 0xC0,     0,
 0xC1,     0,
 0xC2,     0,
 0xC3,     0,
 0xC4,  0x40,
 0xC6,     0,
 0xC7,     0,
 0xC8,     0,
 0xD0,  0xC1,
 0xD1,     8,
 0xD2,  0xFF,
 0xD3,     0,
 0xD4,     0,
 0xD5,  0x3F,
 0xD6,     0,
 0xD7,     0,
 0xD8,     0,
 0xDA,  0x3D,
 0xDB,  0xC3,
 0xDC,  0xFC,
 0xDD,     0,
 0xDE,     0,
 0xDF,     0,
 0xE0,     0,
 0xF0,     0,
 0xF1,     0,
 0xF2,     0,
 0xF4,     0,
 0xF6,     0,
 0xF7,     0,
 0xF8,     0,
 0xF9,     0,
 0xFA,  0xE4,
 0xFB,     0,
 0xFC,  0x40,
 0xFD,  0x30,
 0xFE,     0,
 0xFF,     1,
    0,     0,
 0x30,  0xF2,
 0x31,  0xAD,
 0x32,     4,
 0x33,  0x80,
 0x34,  0x84,
 0x35,     0,
 0x36,  0x20,
 0x40,     0,
 0x41,     0,
 0x75,     0,
 0x76,     0,
 0x77,  0x5A,
 0x78,     0,
 0x79,  0x7F,
 0x7A,     1,
 0x7B,     0,
 0x80,  0x20,
 0x81,     0,
 0x82,     5,
 0x83,  0x1F,
 0x84,     0,
 0x85,     0,
 0x8A,     2,
 0x8B,  0x4D,
 0x8C,     0,
 0x8D,     6,
 0x8E,     1,
 0x8F,  0xE2,
 0x90,     2,
 0x91,  0xD0,
 0x92,     2,
 0x93,  0xD0,
 0x94,     0,
 0x95,     6,
 0x9A,     0,
 0x9B,  0xC8,
 0x9C,     0,
 0x9D,     1,
 0xA0,     0,
 0xA1,     0,
 0xA2,     2,
 0xA3,  0x30,
 0xA4,     0,
 0xA5,     6,
 0xA6,     0,
 0xA7,     1,
 0xAC,     0,
 0xAD,   0xA,
 0xAE,     0,
 0xAF,  0x36,
 0xB0,     2,
 0xB1,     3,
 0xB2,  0x88,
 0xB3,     0,
 0xB4,     0,
 0xC0,     5,
 0xC2,     0,
 0xC3,     3,
 0xC4,  0x5A,
 0xC5,     0,
 0xC6,  0x20,
 0xC7,     4,
 0xC8,     0,
 0xC9,     6,
 0xCA,     6,
 0xCB,  0x70,
 0xCC,     0,
 0xCD,     0,
 0xD0,     0,
 0xD1,  0xF0,
 0xD2,  0xF0,
 0xD3,  0xF0,
 0xD4,     0,
 0xD5,     0,
 0xD6,  0x10,
 0xD7,  0x70,
 0xD8,     0,
 0xD9,     4,
 0xDA,  0x80,
 0xDB,  0x80,
 0xDC,  0x20,
 0xE0,     0,
 0xF0,     0,
 0xF1,     0,
 0xF3,     4,
#endif
    };
    printf("1\n");
    for (unsigned i = 0; i < sizeof(reg_init); i+=2) {
        LCD_WriteReg(reg_init[i], reg_init[i+1]);
    }
    LCD_WriteReg(0xFF, 0x00);
    printf("2\n");

    TW8816_SetVideoMode(0);
    TW8816_ReinitPixelClock();
    LCD_WriteReg(0xFF, 0x00);
    if (LCD_ReadReg(0x00) != 0x22) {
        printf("Could not identify display\n");
    }
    printf("3\n");
    //Clear screen
    LCD_WriteReg(0xFF, 0);
    LCD_WriteReg(0x94, 2);

    //Setup XY Graph
    LCD_WriteReg(0x9e, 0x00);
    LCD_WriteReg(0x9f, 0x01);
    LCD_WriteReg(0xa0, (564 >> 8));
    LCD_WriteReg(0xa1, 0xff & 564); //564
    LCD_WriteReg(0xa2, 126); //126
    LCD_WriteReg(0xa3, 6);
    LCD_WriteReg(0xa4, 4);
    LCD_WriteReg(0xa5, 6);
    LCD_WriteReg(0xa6, 0x00);
    LCD_WriteReg(0xa7, 0x00);
    LCD_WriteReg(0xa8, 0x00);
    LCD_WriteReg(0xa9, 0xA1);
    LCD_WriteReg(0xaa, 0xAE); //0x1AE = 430
    LCD_WriteReg(0xAB,  0x12);
    LCD_WriteReg(0xAC,   0x08);
    LCD_WriteReg(0xAD,     0);
    LCD_WriteReg(0xAE,     0);
    window = 1;
    for(int i = 0; i < 24; i++)
        TW8816_DisplayCharacter(i, 'A' + i, 7);

    //Setup normal display
    LCD_WriteReg(0x9e, 0x01);
    LCD_WriteReg(0x9f, 0x01);
    LCD_WriteReg(0xa0, 0x00);
    LCD_WriteReg(0xa1, 0x00);
    LCD_WriteReg(0xa2, 0x00);
    LCD_WriteReg(0xa6, 0x00);
    LCD_WriteReg(0xa7, 0x00);
    LCD_WriteReg(0xa3, 33);
    LCD_WriteReg(0xa4, 13);
    LCD_WriteReg(0xAC, 0x08);
    LCD_WriteReg(0xA9,  0x50);
    window = 0;
    for(int i = 0; i < 24; i++)
        TW8816_DisplayCharacter(i, 'A' + i, 7);

}

void TW8816_Reset()
{
    gpio_clear(GPIOE, GPIO7);
    _msleep(250);
    gpio_set(GPIOE, GPIO7);
    _msleep(100);
}

void TW8816_LoadFont(u8 *data, unsigned offset, unsigned count)
{
    LCD_WriteReg(0x94, 1);
    LCD_WriteReg(0x9B, 0xE2);
    LCD_WriteReg(0xE0, 0x10);
    for (unsigned i = 0; i < count; i++) {
        LCD_WriteReg(0x99, offset + i);
        I2C1_WriteBufferDMA(0x45, data + i * 27, 0x9A, 27);
    }
    LCD_WriteReg(0x94, 0);
    LCD_WriteReg(0xE0, 0);
}

void TW8816_SetVideoMode(unsigned enable)
{
    unsigned reg = enable ? 0x40 : 0x44;
    if(LCD_ReadReg(0x2) != reg) {
        LCD_WriteReg(0x02, reg);
        LCD_WriteReg(0x2F, enable ? 0xE0 : 0xE6);
    }
}

void TW8816_ReinitPixelClock()
{
    LCD_WriteReg(0xB6, 0xB4);
    LCD_WriteReg(0xB2, 0x20);
    Delay(0x60000);
    LCD_WriteReg(0xB6, 0x34);
}

void TW8816_DisplayCharacter(unsigned pos, unsigned chr, unsigned attr)
{
    if (window == 1)
        pos += 430;
    LCD_WriteReg(0x94, (chr & 0x100) ? 0x80 : 0x00); // isRamFont
    LCD_WriteReg(0x95, pos >> 8);
    LCD_WriteReg(0x96, pos & 0xff);
    LCD_WriteReg(0x97, chr & 0xff);
    LCD_WriteReg(0x98, attr);
}

void TW8816_ClearDisplay()
{
    LCD_WriteReg(0x94, 2);
}

void TW8816_CreateMappedWindow(unsigned val, unsigned x, unsigned y, unsigned w, unsigned h)
{
    (void)w;
    (void)h;
    TW8816_SetWindow(val);
    LCD_WriteReg(0x9f, 0x01);
    x *= 12;
    y *= 18;
    LCD_WriteReg(0xa0, (0x30 & (y >> 4)) | (0x07 & (x >> 8)));
    LCD_WriteReg(0xa1, 0xff & x);
    LCD_WriteReg(0xa2, 0xff & y);
    TW8816_SetWindow(window);
}

void TW8816_SetWindow(unsigned i) {
    LCD_WriteReg(0x9e, i);
}
void TW8816_UnmapWindow(unsigned i)
{
    TW8816_SetWindow(i);
    LCD_WriteReg(0x9f, 0x00);
    TW8816_SetWindow(window);
}
